// kernel.cpp

#include <stddef.h> // Для size_t

// Объявление символов для массива глобальных конструкторов, 
// определенных в linker.ld
extern "C" {
    // Начало массива конструкторов
    extern void (*__init_array_start)(); 
    // Конец массива конструкторов
    extern void (*__init_array_end)(); 
}

// Функция для вызова всех глобальных конструкторов
void call_global_constructors()
{
    // Итерация от начала до конца массива указателей на функции
    for (void (**p)() = &__init_array_start; p < &__init_array_end; p++) {
        // Вызов конструктора
        (*p)();
    }
}

// =================================================================
// 1. Обертка для точки входа C
// =================================================================

// Объявляем функцию, которая будет вызываться из ассемблера.
// extern "C" - критически важно, чтобы предотвратить искажение имен (name mangling),
// поскольку ассемблерный код не знает о правилах именования C++.
extern "C" void kernel_main(unsigned long magic, unsigned long addr);

// =================================================================
// 2. Минимальная поддержка C++ (операторы new/delete)
// =================================================================

// В автономном окружении мы должны предоставить минимальную реализацию,
// даже если мы пока не используем динамическую память.

void* operator new(size_t)
{
    // В реальном ядре здесь будет вызываться менеджер кучи (heap)
    return nullptr;
}

void operator delete(void*) noexcept
{
    // Пока ничего не делаем
}

// =================================================================
// 3. Базовая функция вывода (VGA)
// =================================================================

// Простая функция для записи в текстовый режим (VGA)
void terminal_write(const char* str)
{
    // Начальный адрес видеопамяти VGA
    unsigned char* vga = (unsigned char*)0xB8000;
    
    // Итерация по строке
    for (int i = 0; str[i] != '\0'; ++i) {
        // Символ
        vga[2 * i] = str[i];
        // Атрибут цвета (0x0F = белый текст на черном фоне)
        vga[2 * i + 1] = 0x0F; 
    }
}

// =================================================================
// 4. Основная точка входа ядра
// =================================================================

extern "C" void kernel_main(unsigned long magic, unsigned long addr)
{
    call_global_constructors();
    
    // 0x36D76289 - это Magic Number, ожидаемый для Multiboot2
    if (magic != 0x36D76289) {
        terminal_write("ERROR: Not booted by Multiboot2 bootloader!");
        while(1);
    }

    // Использование C++: Класс для форматированного вывода
    class KernelText
    {
    public:
        void print(const char* message) const
        {
            terminal_write(message);
        }
    };
    
    KernelText text;
    text.print("Hello from C++ Multiboot2 Kernel!");
    
    // Бесконечный цикл, чтобы ядро не завершилось
    while (1) {}
}